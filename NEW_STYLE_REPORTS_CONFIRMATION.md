# âœ… NEW STYLE REPORTS - COMPLETE CONFIRMATION

## ğŸ¯ Summary
**Your system is configured to ONLY generate and deliver NEW style reports with:**
- âœ… Custom cover page from template (`public/coverPage.docx`)
- âœ… Main report content
- âœ… Appraiser CV merged at the end (if available)

**Both admin approval page AND user reports page download the SAME NEW style files.**

---

## ğŸ“Š Complete Report Generation Flow

```
1. User Submits Asset Form
   â””â”€ POST /api/assets/createAssetReport
   
2. runAssetPreviewJob() - Background Processing
   â”œâ”€ Upload images to R2
   â”œâ”€ AI analysis of images
   â”œâ”€ Calculate valuations
   â””â”€ generateAssetDocxFromReport() â† **NEW STYLE ONLY**
      â”œâ”€ Step 1: Generate custom cover page from template
      â”œâ”€ Step 2: Generate main report (mixedDocxBuilder with custom_cover: true)
      â”œâ”€ Step 3: Fetch appraiser CV from URL
      â””â”€ Step 4: Merge all documents using docx-merger
   
3. Upload to R2 Storage
   â”œâ”€ DOCX: previews/asset-preview-{reportId}.docx â† **NEW STYLE**
   â”œâ”€ XLSX: previews/asset-preview-{reportId}.xlsx
   â””â”€ Images: previews/asset-preview-images-{reportId}.zip
   
4. Store URLs in AssetReport.preview_files
   â””â”€ { docx: "...", excel: "...", images: "..." }
   
5. User Reviews in PreviewModal
   â””â”€ Edit metadata if needed
   
6. User Submits for Approval
   â””â”€ Status: preview â†’ pending_approval
   
7. Admin Reviews in /admin/approvals
   â””â”€ Downloads: preview_files URLs (R2 direct) â† **NEW STYLE**
   
8. Admin Approves Report
   â””â”€ runDocxGenerationJob()
      â”œâ”€ Download preview files from R2 â† **NEW STYLE FILES**
      â”œâ”€ Save locally: reports/{userId}/asset-report-{reportId}.docx
      â””â”€ Create PdfReport database records
   
9. User Downloads from /reports
   â””â”€ Downloads: Local files (copies of preview) â† **NEW STYLE**
```

---

## ğŸ”‘ Key Code Paths

### Preview Generation (NEW Style)
**File:** `server/src/jobs/assetReportJob.ts` (Line 91)
```typescript
const docxBuffer = await generateAssetDocxFromReport(reportData);
```

### DOCX Generation Service (NEW Style)
**File:** `server/src/service/assetDocxService.ts`
```typescript
export async function generateAssetDocxFromReport(reportData: any): Promise<Buffer> {
  // Step 1: Custom cover page
  const coverBuffer = await generateCoverPage(reportData);
  
  // Step 2: Main report (without built-in cover)
  const mainBuffer = await generateMixedDocx({
    ...reportData,
    custom_cover: true, // Skip built-in cover
  });
  
  // Step 3: Fetch CV
  const cvBuffer = await fetchAppraiserCV(reportData.user_cv_url);
  
  // Step 4: Merge all
  const finalBuffer = await mergeDocuments(coverBuffer, mainBuffer, cvBuffer);
  
  return finalBuffer;
}
```

### File Promotion After Approval
**File:** `server/src/jobs/assetReportJob.ts` (Lines 2350-2398)
```typescript
// Downloads preview files (NEW style) from R2
const [docxRes, xlsxRes, imagesRes] = await Promise.all([
  axios.get(previewDocxUrl, { responseType: "arraybuffer" }),
  // ...
]);

// Saves locally for user download API
await fs.writeFile(localDocxPath, docxBuffer);
```

---

## ğŸ“¥ Download Paths

### Admin Approvals Page
**Location:** `admin/components/admin/AdminApprovals.tsx`
```tsx
// Direct download from R2 storage (NEW style files)
<a href={g.preview_files.docx} target="_blank">DOCX</a>
```

### User Reports Page
**Location:** `web/app/(main)/reports/page.tsx`
```tsx
// Download via backend API (serves local files - copies of NEW style)
async function handleDownload(id: string) {
  // For AssetReports: direct URL from preview_files
  if (reportWithUrl && reportWithUrl.url) {
    const response = await fetch(directUrl);
    // ...
  }
  // For legacy: backend API
  else {
    const { blob } = await ReportsService.downloadReport(id);
    // ...
  }
}
```

---

## ğŸ¨ NEW Style Components

### 1. Custom Cover Page Template
**Location:** `server/public/coverPage.docx` (450KB)
**Fields:**
- `{preparedFor}` - From form or client name
- `{reportDate}` - Effective date or current date
- `{userEmail}` - Appraiser email

### 2. Main Report Content
**Generated by:** `mixedDocxBuilder.ts`
**Includes:**
- Report Summary
- Report Details (with "Prepared For" field)
- Conditions of Appraisal
- Purpose & Scope
- Factors Affecting Value (Age & Condition, Quality, Analysis)
- Value Terminology
- Asset Lots with images
- Valuation Comparison Table (if requested)
- Headers/Footers with corporate info

### 3. Appraiser CV
**Source:** User.cvUrl (if available)
**Format:** Complete CV document
**Divider:** Automatically added heading "Appraiser CV"

---

## ğŸ“ Console Logging

When you generate a report, you'll see:

```
================================================================================
ğŸš€ [PreviewFilesJob] GENERATING DOCX WITH NEW STYLE (CUSTOM COVER + CV MERGE)
================================================================================
ğŸ“‹ Report ID: 67890abc
ğŸ‘¤ User: John Doe (john@example.com)
ğŸ“„ Prepared For: Acme Corp
ğŸ“ CV URL: https://example.com/cv.docx
================================================================================

ğŸ“„ [AssetDOCX] Starting NEW report generation with custom cover + CV...
ğŸ“„ [AssetDOCX] Step 1: Generating custom cover page...
âœ… [AssetDOCX] Cover page generated (450150 bytes)
ğŸ“„ [AssetDOCX] Step 2: Generating main report content...
âœ… [AssetDOCX] Main report generated (2456789 bytes)
ğŸ“„ [AssetDOCX] Step 3: Fetching appraiser CV...
âœ… [AssetDOCX] CV fetched (123456 bytes)
ğŸ“„ [AssetDOCX] Step 4: Merging documents...
âœ… [AssetDOCX] Final merged document (2580345 bytes)
ğŸ‰ [AssetDOCX] NEW style report generation completed successfully!

âœ… [PreviewFilesJob] DOCX GENERATED SUCCESSFULLY!
ğŸ“¦ Size: 2.46 MB
ğŸ”— Will be uploaded to: https://images.sellsnap.store/previews/asset-preview-67890abc.docx
```

When admin approves:

```
================================================================================
ğŸ“¥ [DocxGenJob] PROMOTING PREVIEW FILES TO APPROVED STATUS
================================================================================
ğŸ”— Preview DOCX URL: https://images.sellsnap.store/previews/asset-preview-67890abc.docx
ğŸ”— Preview XLSX URL: https://images.sellsnap.store/previews/asset-preview-67890abc.xlsx
ğŸ”— Preview Images URL: https://images.sellsnap.store/previews/asset-preview-images-67890abc.zip

â¬‡ï¸ Downloading preview files from R2...
âœ… Downloaded DOCX: 2.46 MB
âœ… Downloaded XLSX: 45 KB
âœ… Downloaded Images: 12.30 MB

ğŸ’¾ Saving files locally for user download API...
âœ… Saved to local filesystem:
   ğŸ“„ /path/to/reports/userId/asset-report-67890abc.docx
   ğŸ“Š /path/to/reports/userId/asset-report-67890abc.xlsx
   ğŸ“¦ /path/to/reports/userId/asset-report-images-67890abc.zip
```

---

## âœ… Verification Checklist

**To confirm NEW style is working:**

1. âœ… **Check template exists:**
   - File: `server/public/coverPage.docx` (450KB)
   - Template should have `{preparedFor}`, `{reportDate}`, `{userEmail}` placeholders

2. âœ… **Create test report:**
   - Fill out AssetForm with "Prepared For" field
   - Submit and wait for processing

3. âœ… **Check console logs:**
   - Should see "NEW STYLE" generation messages
   - Should see 4 merge steps (cover, main, CV, final)

4. âœ… **Admin downloads:**
   - Go to `/admin/approvals`
   - Click DOCX button
   - Verify report has: Custom cover â†’ Main content â†’ CV (if provided)

5. âœ… **Admin approves:**
   - Click "Approve" button
   - Check logs for file promotion

6. âœ… **User downloads:**
   - Go to `/reports`
   - Click DOCX button
   - Verify file is IDENTICAL to admin's download

---

## ğŸš« NO Old Style Reports

**Old style generation has been completely replaced:**
- âŒ No direct `generateMixedDocx()` calls (except internal to assetDocxService)
- âŒ No reports without custom cover page
- âŒ No reports without CV merge capability
- âœ… ALL new reports use `generateAssetDocxFromReport()`
- âœ… ALL downloads come from the same NEW style source

**Note:** Only reports created BEFORE implementing this system will have old style. All NEW reports (created now) will ONLY have NEW style.

---

## ğŸ¯ Final Confirmation

**Both download paths use the SAME files:**

| Download Location | Source | Style |
|------------------|--------|-------|
| Admin Approvals (`/admin/approvals`) | R2 Storage (`preview_files.docx`) | âœ… NEW |
| User Reports (`/reports`) | Local Files (copy of R2) | âœ… NEW |

**File Flow:**
```
generateAssetDocxFromReport() 
  â†’ R2 Storage (preview_files) 
  â†’ Admin Download âœ… NEW STYLE
  â†’ Local Copy (after approval) 
  â†’ User Download âœ… NEW STYLE
```

---

## ğŸ“ Support

If you see any OLD style reports:
1. Check if it's a report created BEFORE this system was implemented
2. Check console logs for errors during generation
3. Verify `coverPage.docx` template exists in `server/public/`
4. Verify user has CV URL populated (if CV should be included)

---

**Last Updated:** October 30, 2025
**Status:** âœ… Production Ready - ALL Reports Generate with NEW Style
