<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Asset Catalogue - {{lots.length}} Lots ({{grouping_mode}})</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      @media print {
        body {
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }
        .page-break { page-break-after: always; }
      }
      body { font-family: "Roboto", sans-serif; background-color: #f7fafc; }
      .brand-rose { color: #e11d48; }
      .bg-brand-rose { background-color: #e11d48; }
      .section-title {
        border-left: 4px solid #e11d48;
        padding-left: 12px;
        margin-bottom: 16px;
        font-weight: 600;
        color: #be123c;
      }
      .card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.06);
        padding: 20px;
        margin-bottom: 20px;
      }
      .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
      }
      .detail-item strong { color: #374151; }
      .stat-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 18px rgba(225, 29, 72, 0.08);
        border: 1px solid #fee2e2;
        padding: 16px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 12px;
        font-weight: 600;
        border: 1px solid #fecdd3; /* rose-200 */
        color: #be123c; /* rose-700 */
        background: #ffe4e6; /* rose-100 */
      }
      .lot-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.06);
        border: 1px solid #f3f4f6;
        padding: 16px;
        break-inside: avoid;
        page-break-inside: avoid;
      }
      .img-tile img {
        width: 100%;
        height: 160px;
        object-fit: contain;
        border-radius: 10px;
        border: 1px solid #fee2e2;
      }
      table { width: 100%; border-collapse: collapse; }
      thead th {
        background: #ffe4e6; /* rose-100 */
        color: #be123c; /* rose-700 */
        border-bottom: 2px solid #fecdd3; /* rose-200 */
        text-align: left;
        font-weight: 700;
        padding: 10px;
        font-size: 13px;
      }
      tbody td {
        border-bottom: 1px solid #f3f4f6;
        padding: 10px;
        font-size: 13px;
        vertical-align: top;
      }
      .thumb { width: 220px; height: 160px; object-fit: contain; border-radius: 0px; border: 0; background: transparent; }
    </style>
  </head>
  <body class="bg-slate-50">
    <!-- Cover Page -->
    <section id="cover-page" class="w-full h-screen flex flex-col bg-white">
      <div class="relative flex-grow flex items-center justify-center">
        <div class="absolute inset-0 z-0">
          <img src="{{lookup imageUrls 0}}" alt="Asset Image" class="w-full h-full object-cover opacity-10" />
          <div class="absolute inset-0 bg-gradient-to-b from-white/80 via-white/75 to-white/90"></div>
        </div>
        <div class="relative z-10 text-center p-8">
          <img src="{{logo_url}}" alt="Company Logo" class="h-20 mx-auto mb-6" />
          <h1 class="text-5xl font-bold brand-rose mb-4">Asset Catalogue</h1>
          <p class="text-2xl text-gray-700">{{lots.length}} Lots ({{grouping_mode}})</p>
        </div>
      </div>
      <div class="bg-brand-rose text-white p-6">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
          <div>
            <p class="font-semibold">Prepared for:</p>
            <p class="text-lg">{{#if client_name}}{{client_name}}{{else}}{{inspector_name}}{{/if}}</p>
          </div>
          <div class="text-right">
            <p class="font-semibold">Report Date:</p>
            <p class="text-lg">{{formatDate createdAt}}</p>
          </div>
        </div>
      </div>
    </section>

    <div class="page-break"></div>

    <div class="max-w-none mx-auto p-4 sm:p-8">
      <!-- Transmittal Letter -->
      <section class="card">
        <h2 class="text-3xl font-semibold section-title">Transmittal Letter</h2>
        <div class="text-sm text-gray-600 mb-3">
          <strong class="text-gray-800">Reference:</strong>
          {{#if appraisal_purpose}}{{appraisal_purpose}}{{else}}Asset Appraisal Report{{/if}}
        </div>
        <div class="space-y-3 text-gray-700 leading-relaxed">
          <p>Dear {{#if client_name}}{{client_name}}{{else}}Client{{/if}},</p>
          <p>
            At the request of {{#if client_name}}{{client_name}}{{else}}the Client{{/if}}, we have prepared an appraisal of certain assets owned by
            {{#if owner_name}}{{owner_name}}{{else}}the Owner{{/if}}, a copy of which is enclosed. This appraisal report is intended for exclusive use by
            {{#if client_name}}{{client_name}}{{else}}the Client{{/if}} and is intended only for establishing values of the listed assets.
          </p>
          <p>
            The subject assets were appraised under a premise of value appropriate for internal consideration. The cost and market approaches to value
            have been considered for this appraisal and have either been utilized where necessary or deemed inappropriate for the value conclusions found therein.
          </p>
          <p>
            After a thorough analysis of the assets and information made available to us, it is our opinion that as of the Effective Date ({{#if effective_date}}{{formatDate effective_date}}{{else}}{{formatDate createdAt}}{{/if}}),
            these assets have a Fair Market Value as shown on the certificate that we have prepared.
          </p>
          <p>If you require any additional information, please feel free to contact me at your convenience.</p>
          <div class="pt-2">
            <p class="font-semibold text-gray-900">{{#if appraiser}}{{appraiser}}{{else}}Appraiser{{/if}}, CPPA</p>
            <p class="text-gray-700">Certified Appraiser</p>
            {{#if appraisal_company}}<p class="text-gray-700">{{appraisal_company}}</p>{{/if}}
          </div>
        </div>
      </section>

      <!-- Certificate of Appraisal -->
      <section class="card">
        <h2 class="text-3xl font-semibold section-title">Certificate of Appraisal</h2>
        <div class="space-y-3 text-gray-700 leading-relaxed">
          <p>
            I hereby certify that I have personally inspected the assets described herein, and have made a thorough analysis of all factors pertinent to their value,
            in accordance with the requirements of the Uniform Standards of Professional Appraisal Practice.
          </p>
          <div class="mt-3 rounded-lg border border-rose-200 bg-rose-50 p-4 text-center">
            <div class="text-xs uppercase tracking-wide text-rose-700">Total Appraised Value</div>
            {{#if total_appraised_value}}
              <div class="mt-1 text-2xl font-bold text-rose-800">{{total_appraised_value}}</div>
            {{else}}
              {{#if total_value}}
                <div class="mt-1 text-2xl font-bold text-rose-800">{{total_value}}</div>
              {{else}}
                {{#if analysis.total_value}}
                  <div class="mt-1 text-2xl font-bold text-rose-800">{{analysis.total_value}}</div>
                {{else}}
                  <div class="mt-1 text-sm text-rose-700">See Report Details and item estimates for values.</div>
                {{/if}}
              {{/if}}
            {{/if}}
          </div>
        </div>
      </section>

      <!-- Report Summary -->
      <section class="card">
        <h2 class="text-3xl font-semibold section-title">Report Summary</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="stat-card">
            <div class="text-sm text-gray-500">Grouping Mode</div>
            <div class="mt-1 text-xl font-semibold text-gray-900 capitalize">{{grouping_mode}}</div>
          </div>
          <div class="stat-card">
            <div class="text-sm text-gray-500">Total Lots</div>
            <div class="mt-1 text-xl font-semibold text-gray-900">{{lots.length}}</div>
          </div>
          <div class="stat-card">
            <div class="text-sm text-gray-500">Total Images</div>
            <div class="mt-1 text-xl font-semibold text-gray-900">{{imageUrls.length}}</div>
          </div>
        </div>
        {{#if analysis.summary}}
          <div class="mt-4 stat-card">
            <h3 class="font-semibold brand-rose mb-1">AI Summary</h3>
            <p class="text-gray-700">{{analysis.summary}}</p>
          </div>
        {{/if}}
      </section>

      <!-- Report Details -->
      <section class="card">
        <h2 class="text-2xl font-semibold section-title">Report Details</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {{#if client_name}}<div class="detail-item"><strong>Client Name</strong><span>{{client_name}}</span></div>{{/if}}
          {{#if effective_date}}<div class="detail-item"><strong>Effective Date</strong><span>{{formatDate effective_date}}</span></div>{{/if}}
          {{#if appraisal_purpose}}<div class="detail-item"><strong>Appraisal Purpose</strong><span>{{appraisal_purpose}}</span></div>{{/if}}
          {{#if owner_name}}<div class="detail-item"><strong>Owner Name</strong><span>{{owner_name}}</span></div>{{/if}}
          {{#if appraiser}}<div class="detail-item"><strong>Appraiser</strong><span>{{appraiser}}</span></div>{{/if}}
          {{#if appraisal_company}}<div class="detail-item"><strong>Appraisal Company</strong><span>{{appraisal_company}}</span></div>{{/if}}
          {{#if industry}}<div class="detail-item"><strong>Industry</strong><span>{{industry}}</span></div>{{/if}}
          {{#if inspection_date}}<div class="detail-item"><strong>Inspection Date</strong><span>{{formatDate inspection_date}}</span></div>{{/if}}
        </div>
      </section>

      <!-- Catalogue Lots with Nested Items -->
      {{#each lots}}
      <section class="lot-card">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <h3 class="text-xl font-bold brand-rose">
            <span class="text-sm text-gray-500 font-medium">Lot {{lot_id}}</span>
            <span class="mx-2">—</span>{{title}}
          </h3>
          <div class="flex items-center gap-2">
            {{#if condition}}<span class="badge">{{condition}}</span>{{/if}}
            {{#if estimated_value}}<span class="badge">Est. Value: {{estimated_value}}</span>{{/if}}
            {{#if items}}<span class="badge">Items: {{items.length}}</span>{{/if}}
          </div>
        </div>
        <p class="text-gray-700 mt-2 whitespace-pre-line">{{description}}</p>

        <!-- Lot Images -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
          {{#if image_urls}}
            {{#each image_urls}}
              <div class="img-tile"><img src="{{this}}" alt="Lot Image {{@index}}" /></div>
            {{/each}}
          {{else}}
            {{#each image_indexes}}
              <div class="img-tile"><img src="{{lookup @root.imageUrls this}}" alt="Lot Image {{this}}" /></div>
            {{/each}}
          {{/if}}
        </div>

        <!-- Items Table -->
        <div class="mt-4 overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Title</th>
                <th>SN/VIN</th>
                <th>Description</th>
                <th>Details</th>
                <th>Est. Value (CAD)</th>
                <th>Image</th>
              </tr>
            </thead>
            <tbody>
              {{#if items}}
                {{#each items}}
                  <tr>
                    <td class="font-semibold text-gray-900">{{title}}</td>
                    <td>{{#if sn_vin}}{{sn_vin}}{{else}}not found{{/if}}</td>
                    <td class="whitespace-pre-line">{{#if description}}{{description}}{{else}}—{{/if}}</td>
                    <td class="whitespace-pre-line">{{#if details}}{{details}}{{else}}—{{/if}}</td>
                    <td>{{#if estimated_value}}{{estimated_value}}{{else}}—{{/if}}</td>
                    <td>
                      {{#if image_url}}
                        <img src="{{image_url}}" alt="Item" class="thumb" />
                      {{else}}
                        {{#if (lookup @root.imageUrls image_index)}}
                          <img src="{{lookup @root.imageUrls image_index}}" alt="Item" class="thumb" />
                        {{else}}
                          <div class="text-xs text-gray-400">No image</div>
                        {{/if}}
                      {{/if}}
                    </td>
                  </tr>
                {{/each}}
              {{else}}
                <tr>
                  <td colspan="6" class="text-center text-gray-500 py-4">No items found in this lot.</td>
                </tr>
              {{/if}}
            </tbody>
          </table>
        </div>
      </section>
      {{/each}}
    </div>
  </body>
</html>
